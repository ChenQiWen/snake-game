# å·¥ä½œæµåç§°
name: 'ğŸ’¬ Gemini CLI (å¯å¤ç”¨)'

# è§¦å‘æ¡ä»¶ï¼šå®šä¹‰ä¸ºå¯è¢«å…¶ä»–å·¥ä½œæµè°ƒç”¨
on:
  workflow_call:
    # å®šä¹‰è¾“å…¥å‚æ•°
    inputs:
      user_request:
        description: 'ä»è¯„è®ºæˆ– Issue æ­£æ–‡ä¸­æå–çš„ç”¨æˆ·è¯·æ±‚æ–‡æœ¬'
        required: true
        type: string
      issue_number:
        description: 'å…³è”çš„ Issue æˆ– PR ç¼–å·'
        required: true
        type: number
      is_pr:
        description: 'ä¸Šä¸‹æ–‡æ˜¯å¦ä¸ºä¸€ä¸ª Pull Request (true/false)'
        required: true
        type: boolean
    # å®šä¹‰æ‰€éœ€å¯†é’¥
    secrets:
      APP_PRIVATE_KEY:
        description: 'GitHub App çš„ç§é’¥'
        required: false
      GEMINI_API_KEY:
        description: 'Gemini API çš„å¯†é’¥'
        required: false

# å¹¶å‘æ§åˆ¶ï¼šç¡®ä¿å¯¹åŒä¸€ä¸ª Issue/PR çš„å¤„ç†ä¸ä¼šé‡å¤æ‰§è¡Œ
concurrency:
  group: '${{ github.workflow }}-${{ inputs.issue_number }}'
  cancel-in-progress: true

# é»˜è®¤è®¾ç½®
defaults:
  run:
    shell: 'bash'

# æƒé™è®¾ç½®
permissions:
  contents: 'write'      # éœ€è¦å†™å…¥æƒé™æ¥æäº¤ä»£ç ä¿®æ”¹
  id-token: 'write'
  pull-requests: 'write'
  issues: 'write'

# ä½œä¸šå®šä¹‰
jobs:
  gemini-cli:
    # è°ƒç”¨æ–¹è´Ÿè´£æ§åˆ¶æ‰§è¡Œé€»è¾‘ï¼Œæ•…ç§»é™¤ 'if' æ¡ä»¶
    timeout-minutes: 10
    runs-on: 'ubuntu-latest'
    
    # ä½œä¸šæ­¥éª¤
    steps:
      # æ­¥éª¤1: (å¯é€‰) ç”Ÿæˆ GitHub App Token
      - name: 'Generate GitHub App Token'
        id: 'generate_token'
        if: ${{ vars.APP_ID != '' }}
        uses: 'actions/create-github-app-token@v2'
        with:
          app-id: '${{ vars.APP_ID }}'
          private-key: '${{ secrets.APP_PRIVATE_KEY }}'

      # æ­¥éª¤2: ä»è°ƒç”¨æ–¹ä¼ å…¥çš„ inputs ä¸­è®¾ç½®ä¸Šä¸‹æ–‡ä¿¡æ¯
      - name: 'Set context from inputs'
        id: 'get_context'
        run: |-
          echo "user_request=${{ inputs.user_request }}" >> "${GITHUB_OUTPUT}"
          echo "issue_number=${{ inputs.issue_number }}" >> "${GITHUB_OUTPUT}"
          echo "is_pr=${{ inputs.is_pr }}" >> "${GITHUB_OUTPUT}"

      # æ­¥éª¤3: è®¾ç½® Git æäº¤è€…ä¿¡æ¯
      - name: 'Set up git user for commits'
        run: |-
          git config --global user.name 'gemini-cli[bot]'
          git config --global user.email 'gemini-cli[bot]@users.noreply.github.com'

      # æ­¥éª¤4: å¦‚æœæ˜¯ PRï¼Œæ£€å‡º PR æ‰€åœ¨çš„åˆ†æ”¯
      - name: 'Checkout PR branch'
        if: steps.get_context.outputs.is_pr == 'true'
        uses: 'actions/checkout@v4'
        with:
          token: '${{ steps.generate_token.outputs.token || secrets.GITHUB_TOKEN }}'
          repository: '${{ github.repository }}'
          ref: 'refs/pull/${{ steps.get_context.outputs.issue_number }}/head'
          fetch-depth: 0

      # æ­¥éª¤5: å¦‚æœæ˜¯ Issueï¼Œæ£€å‡ºé»˜è®¤ä¸»åˆ†æ”¯
      - name: 'Checkout main branch'
        if: steps.get_context.outputs.is_pr == 'false'
        uses: 'actions/checkout@v4'
        with:
          token: '${{ steps.generate_token.outputs.token || secrets.GITHUB_TOKEN }}'
          repository: '${{ github.repository }}'
          fetch-depth: 0

      # æ­¥éª¤6: åœ¨ Issue/PR ä¸‹å‘è¡¨è¯„è®ºï¼Œå‘ŠçŸ¥ç”¨æˆ·å·²å¼€å§‹å¤„ç†
      - name: 'Acknowledge request'
        env:
          GITHUB_ACTOR: '${{ github.actor }}'
          GITHUB_TOKEN: '${{ steps.generate_token.outputs.token || secrets.GITHUB_TOKEN }}'
          ISSUE_NUMBER: '${{ steps.get_context.outputs.issue_number }}'
          REPOSITORY: '${{ github.repository }}'
        run: |-
          set -euo pipefail
          MESSAGE="@${GITHUB_ACTOR} æˆ‘å·²æ”¶åˆ°æ‚¨çš„è¯·æ±‚ï¼Œæ­£åœ¨å¤„ç†ä¸­ï¼ğŸ¤–"
          gh issue comment "${ISSUE_NUMBER}" --body "${MESSAGE}" --repo "${REPOSITORY}"

      # æ­¥éª¤7: è·å– Issue æˆ– PR çš„æè¿°æ­£æ–‡
      - name: 'Get description'
        id: 'get_description'
        env:
          GITHUB_TOKEN: '${{ steps.generate_token.outputs.token || secrets.GITHUB_TOKEN }}'
          IS_PR: '${{ steps.get_context.outputs.is_pr }}'
          ISSUE_NUMBER: '${{ steps.get_context.outputs.issue_number }}'
        run: |-
          set -euo pipefail
          if [[ "${IS_PR}" == "true" ]]; then
            DESCRIPTION=$(gh pr view "${ISSUE_NUMBER}" --json body --template '{{.body}}')
          else
            DESCRIPTION=$(gh issue view "${ISSUE_NUMBER}" --json body --template '{{.body}}')
          fi
          {
            echo "description<<EOF"
            echo "${DESCRIPTION}"
            echo "EOF"
          } >> "${GITHUB_OUTPUT}"

      # æ­¥éª¤8: è·å– Issue æˆ– PR çš„æ‰€æœ‰è¯„è®º
      - name: 'Get comments'
        id: 'get_comments'
        env:
          GITHUB_TOKEN: '${{ steps.generate_token.outputs.token || secrets.GITHUB_TOKEN }}'
          IS_PR: '${{ steps.get_context.outputs.is_pr }}'
          ISSUE_NUMBER: '${{ steps.get_context.outputs.issue_number }}'
        run: |-
          set -euo pipefail
          if [[ "${IS_PR}" == "true" ]]; then
            COMMENTS=$(gh pr view "${ISSUE_NUMBER}" --json comments --template '{{range .comments}}{{.author.login}}: {{.body}}{{"\n"}}{{end}}')
          else
            COMMENTS=$(gh issue view "${ISSUE_NUMBER}" --json comments --template '{{range .comments}}{{.author.login}}: {{.body}}{{"\n"}}{{end}}')
          fi
          {
            echo "comments<<EOF"
            echo "${COMMENTS}"
            echo "EOF"
          } >> "${GITHUB_OUTPUT}"

      # æ­¥éª¤9: è¿è¡Œ Gemini CLI æ ¸å¿ƒé€»è¾‘
      - name: 'Run Gemini'
        id: 'run_gemini'
        uses: 'google-github-actions/run-gemini-cli@v0'
        env:
          # å°†å‰é¢æ‰€æœ‰æ­¥éª¤æ”¶é›†åˆ°çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ä¼ é€’ç»™ Gemini
          GITHUB_TOKEN: '${{ steps.generate_token.outputs.token || secrets.GITHUB_TOKEN }}'
          REPOSITORY: '${{ github.repository }}'
          USER_REQUEST: '${{ steps.get_context.outputs.user_request }}'
          ISSUE_NUMBER: '${{ steps.get_context.outputs.issue_number }}'
          IS_PR: '${{ steps.get_context.outputs.is_pr }}'
        with:
          # Gemini CLI é…ç½®
          gemini_api_key: '${{ secrets.GEMINI_API_KEY }}'
          gcp_workload_identity_provider: '${{ vars.GCP_WIF_PROVIDER }}'
          gcp_project_id: '${{ vars.GOOGLE_CLOUD_PROJECT }}'
          gcp_location: '${{ vars.GOOGLE_CLOUD_LOCATION }}'
          gcp_service_account: '${{ vars.SERVICE_ACCOUNT_EMAIL }}'
          use_vertex_ai: '${{ vars.GOOGLE_GENAI_USE_VERTEXAI }}'
          use_gemini_code_assist: '${{ vars.GOOGLE_GENAI_USE_GCA }}'
          settings: |-
            {
              "debug": false,
              "maxSessionTurns": 50
            }
          # ... æ­¤å¤„çœç•¥äº†é•¿ç¯‡çš„ prompt ...
          prompt: |-
            ## Role
            You are a helpful AI assistant...
