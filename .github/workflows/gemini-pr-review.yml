# å·¥ä½œæµåç§°
name: 'ğŸ§ Gemini Pull Request Review (å¯å¤ç”¨)'

# è§¦å‘æ¡ä»¶ï¼šå®šä¹‰ä¸ºå¯è¢«å…¶ä»–å·¥ä½œæµè°ƒç”¨
on:
  workflow_call:
    # å®šä¹‰è°ƒç”¨æ—¶å¯ä»¥æ¥æ”¶çš„è¾“å…¥å‚æ•°
    inputs:
      pr_number:
        description: 'éœ€è¦å®¡æŸ¥çš„ Pull Request ç¼–å·'
        required: true # è¿™ä¸ªå‚æ•°æ˜¯å¿…é¡»çš„
        type: number   # ç±»å‹ä¸ºæ•°å­—
    # å®šä¹‰è°ƒç”¨æ—¶éœ€è¦æ¥æ”¶çš„å¯†é’¥
    secrets:
      APP_PRIVATE_KEY:
        description: 'GitHub App çš„ç§é’¥ï¼Œç”¨äºç”Ÿæˆæ›´é«˜æƒé™çš„ Token'
        required: false # éå¿…é¡»ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™ä¼šä½¿ç”¨é»˜è®¤çš„ GITHUB_TOKEN
      GEMINI_API_KEY:
        description: 'è°ƒç”¨ Gemini API æ‰€éœ€çš„å¯†é’¥'
        required: false # éå¿…é¡»ï¼Œä½†å¦‚æœéœ€è¦ä½¿ç”¨ Gemini API åˆ™ä¸ºå¿…é¡»

# å¹¶å‘æ§åˆ¶ï¼šç¡®ä¿å¯¹äºåŒä¸€ä¸ªPRï¼Œåªæœ‰ä¸€ä¸ªå®¡æŸ¥å·¥ä½œæµåœ¨è¿è¡Œ
concurrency:
  group: '${{ github.workflow }}-${{ github.head_ref || github.ref }}'
  cancel-in-progress: true

# é»˜è®¤è®¾ç½®
defaults:
  run:
    shell: 'bash' # é»˜è®¤ä½¿ç”¨ bash shell

# æƒé™è®¾ç½®ï¼šä¸ºå·¥ä½œæµè¿è¡Œèµ‹äºˆå¿…è¦çš„æƒé™
permissions:
  contents: 'read'       # è¯»å–ä»“åº“å†…å®¹
  id-token: 'write'      # ç”¨äº OpenID Connect (OIDC) è®¤è¯ï¼Œä¾‹å¦‚ä¸äº‘æœåŠ¡å•†äº¤äº’
  issues: 'write'        # åˆ›å»ºå’Œä¿®æ”¹ Issue
  pull-requests: 'write' # åˆ›å»ºå’Œä¿®æ”¹ Pull Request (ä¾‹å¦‚å‘è¡¨è¯„è®º)
  statuses: 'write'      # æ›´æ–° commit çš„çŠ¶æ€

# ä½œä¸šå®šä¹‰
jobs:
  review-pr:
    # ç”±äºè¿™æ˜¯ä¸€ä¸ªå¯å¤ç”¨å·¥ä½œæµï¼Œæˆæƒé€»è¾‘ç”±è°ƒç”¨æ–¹å¤„ç†ï¼Œå› æ­¤ç§»é™¤äº†å¤æ‚çš„ 'if' æ¡ä»¶
    timeout-minutes: 5 # è®¾ç½®ä½œä¸šè¶…æ—¶æ—¶é—´ä¸º5åˆ†é’Ÿ
    runs-on: 'ubuntu-latest' # æŒ‡å®šè¿è¡Œç¯å¢ƒä¸ºæœ€æ–°çš„ Ubuntu ç³»ç»Ÿ
    
    # ä½œä¸šæ­¥éª¤
    steps:
      # æ­¥éª¤1: æ£€å‡ºä»£ç 
      - name: 'Checkout PR code'
        uses: 'actions/checkout@v4'

      # æ­¥éª¤2: (å¯é€‰) ç”Ÿæˆ GitHub App Token
      # ä»…å½“ä»“åº“å˜é‡ä¸­è®¾ç½®äº† APP_ID æ—¶æ‰æ‰§è¡Œæ­¤æ­¥éª¤
      # ä½¿ç”¨ GitHub App çš„ç§é’¥å¯ä»¥è·å¾—æ¯”é»˜è®¤ GITHUB_TOKEN æ›´é«˜çš„æƒé™å’Œé…é¢
      - name: 'Generate GitHub App Token'
        id: 'generate_token'
        if: ${{ vars.APP_ID != '' }}
        uses: 'actions/create-github-app-token@v2'
        with:
          app-id: '${{ vars.APP_ID }}' # ä»ä»“åº“å˜é‡è·å– App ID
          private-key: '${{ secrets.APP_PRIVATE_KEY }}' # ä»è°ƒç”¨æ–¹ä¼ å…¥çš„å¯†é’¥è·å–ç§é’¥

      # æ­¥éª¤3: è·å– PR çš„è¯¦ç»†ä¿¡æ¯
      - name: 'Get PR details'
        id: 'get_pr'
        env:
          # ä¼˜å…ˆä½¿ç”¨ä¸Šä¸€æ­¥ç”Ÿæˆçš„ App Tokenï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œåˆ™ä½¿ç”¨æ ‡å‡†çš„ GITHUB_TOKEN
          GITHUB_TOKEN: '${{ steps.generate_token.outputs.token || secrets.GITHUB_TOKEN }}'
          # ä»è°ƒç”¨æ–¹ä¼ å…¥çš„ inputs ä¸­è·å– PR ç¼–å·
          PR_NUMBER: '${{ inputs.pr_number }}'
        run: |-
          set -euo pipefail

          # å°† PR ç¼–å·è®¾ç½®ä¸ºè¾“å‡ºï¼Œä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "pr_number=${PR_NUMBER}" >> "${GITHUB_OUTPUT}"

          # ä½¿ç”¨ GitHub CLI (gh) è·å– PR çš„å…ƒæ•°æ® (æ ‡é¢˜ã€æ­£æ–‡ã€ä»£ç å¢åˆ ç­‰)
          PR_DATA="$(gh pr view "${PR_NUMBER}" --json title,body,additions,deletions,changedFiles,baseRefName,headRefName)"
          echo "pr_data=${PR_DATA}" >> "${GITHUB_OUTPUT}"

          # ä½¿ç”¨ GitHub CLI è·å– PR ä¸­è¢«ä¿®æ”¹çš„æ–‡ä»¶åˆ—è¡¨
          CHANGED_FILES="$(gh pr diff "${PR_NUMBER}" --name-only)"
          {
            echo "changed_files<<EOF"
            echo "${CHANGED_FILES}"
            echo "EOF"
          } >> "${GITHUB_OUTPUT}"

      # æ­¥éª¤4: è¿è¡Œ Gemini è¿›è¡Œ PR å®¡æŸ¥
      - name: 'Run Gemini PR Review'
        uses: 'google-github-actions/run-gemini-cli@v0'
        id: 'gemini_pr_review'
        env:
          # å°†å‰é¢æ­¥éª¤è·å–åˆ°çš„ä¿¡æ¯é€šè¿‡ç¯å¢ƒå˜é‡ä¼ é€’ç»™ Gemini CLI
          GITHUB_TOKEN: '${{ steps.generate_token.outputs.token || secrets.GITHUB_TOKEN }}'
          PR_NUMBER: '${{ steps.get_pr.outputs.pr_number }}'
          PR_DATA: '${{ steps.get_pr.outputs.pr_data }}'
          CHANGED_FILES: '${{ steps.get_pr.outputs.changed_files }}'
          ADDITIONAL_INSTRUCTIONS: '' # é¢å¤–çš„å®¡æŸ¥æŒ‡ä»¤ï¼Œè¿™é‡Œç•™ç©ºï¼Œå¯ä»¥æ‰©å±•ä¸º input
          REPOSITORY: '${{ github.repository }}' # å½“å‰ä»“åº“ä¿¡æ¯
        with:
          # Gemini CLI çš„é…ç½®å‚æ•°
          gemini_cli_version: '${{ vars.GEMINI_CLI_VERSION }}' # CLI ç‰ˆæœ¬
          gcp_workload_identity_provider: '${{ vars.GCP_WIF_PROVIDER }}' # Google Cloud Workload Identity Provider
          gcp_project_id: '${{ vars.GOOGLE_CLOUD_PROJECT }}' # Google Cloud é¡¹ç›® ID
          gcp_location: '${{ vars.GOOGLE_CLOUD_LOCATION }}' # Google Cloud åŒºåŸŸ
          gcp_service_account: '${{ vars.SERVICE_ACCOUNT_EMAIL }}' # Google Cloud æœåŠ¡è´¦å·
          gemini_api_key: '${{ secrets.GEMINI_API_KEY }}' # Gemini API å¯†é’¥
          use_vertex_ai: '${{ vars.GOOGLE_GENAI_USE_VERTEXAI }}' # æ˜¯å¦ä½¿ç”¨ Vertex AI
          use_gemini_code_assist: '${{ vars.GOOGLE_GENAI_USE_GCA }}' # æ˜¯å¦ä½¿ç”¨ Gemini Code Assist
          settings: |-
            {
              "debug": false,
              "maxSessionTurns": 20
            }
          # ... æ­¤å¤„çœç•¥äº†é•¿ç¯‡çš„ prompt ...
          prompt: |-
            ## Role
            You are an expert code reviewer...

      # æ­¥éª¤5: (å¤±è´¥æ—¶) å‘è¡¨è¯„è®ºé€šçŸ¥ç”¨æˆ·
      # ä»…å½“ä¸Šä¸€æ­¥ 'gemini_pr_review' å¤±è´¥æ—¶æ‰§è¡Œ
      - name: 'Post PR review failure comment'
        if: failure() && steps.gemini_pr_review.outcome == 'failure'
        uses: 'actions/github-script@v6'
        with:
          github-token: '${{ steps.generate_token.outputs.token || secrets.GITHUB_TOKEN }}'
          script: |-
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.get_pr.outputs.pr_number }},
              body: 'Gemini CLI PR å®¡æŸ¥æ—¶å‡ºç°é—®é¢˜ã€‚è¯·æ£€æŸ¥ [Action æ—¥å¿—](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) è·å–è¯¦ç»†ä¿¡æ¯ã€‚'
            })
